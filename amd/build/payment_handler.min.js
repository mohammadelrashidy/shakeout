define(["jquery","core/modal_factory","core/modal_events","core/str"],function(e,t,a,r){"use strict";function n(t){e(document).ready(function(){o(t)})}function o(t){var a=e("#shakeout-pay-btn"),r=e("#shakeout-loading");0===a.length?console.error("Shake-Out: Payment button not found"):(a.off("click.shakeout"),a.on("click.shakeout",function(e){e.preventDefault(),e.stopPropagation(),a.prop("disabled")||i(t,a,r)}))}function i(e,t,a){s(e,function(){l(e,t,a)})}function s(e,n){var o=t.create({type:t.types.SAVE_CANCEL,title:r.get_string("paymentconfirm","paygw_shakeout"),body:e.confirmMessage||"Are you sure you want to proceed with this payment?",removeOnClose:!1});o.then(function(e){return e.getRoot().on("hidden.bs.modal",function(e){e.stopPropagation()}),e.getRoot().on(a.save,function(t){t.preventDefault(),t.stopPropagation(),e.hide(),setTimeout(function(){e.destroy(),n()},100)}),e.getRoot().on(a.cancel,function(t){t.preventDefault(),t.stopPropagation(),e.hide(),setTimeout(function(){e.destroy()},100)}),e.show(),setTimeout(function(){e.getRoot().find(".btn-primary").focus()},200),e}).catch(function(t){console.error("Shake-Out: Error creating confirmation modal:",t),(confirm(e.confirmMessage||"Are you sure you want to proceed with this payment?"))&&n()})}function l(e,t,a){t.prop("disabled",!0),t.html('<i class="fa fa-spinner fa-spin"></i> '+(e.processingMessage||"Processing...")),a.length>0&&a.show(),setTimeout(function(){c(e.paymentUrl).then(function(r){r?window.location.href=e.paymentUrl:u(e,t,a)})},500)}function c(e){return new Promise(function(t){var a=new XMLHttpRequest;a.timeout=5e3,a.onreadystatechange=function(){4===a.readyState&&t(0!==a.status)},a.ontimeout=function(){t(!1)},a.onerror=function(){t(!1)};try{a.open("HEAD",e,!0),a.send()}catch(e){t(!1)}})}function u(e,a,n){n.length>0&&n.hide(),a.prop("disabled",!1),a.html('<i class="fa fa-credit-card"></i> Pay now');var o=e.errorMessage||"Payment gateway is currently unavailable. Please try again later or contact support.",i=t.create({type:t.types.ALERT,title:r.get_string("error","core"),body:o});i.then(function(e){return e.show(),e}).catch(function(e){console.error("Shake-Out: Error showing error modal:",e),alert(o)})}return{init:n}});